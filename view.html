<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supriya Digitals | Client Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="img/icon1.png" rel="icon">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <style>
        :root { --primary: #D4AF37; --text: #333; --bg: #fdfdfd; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Montserrat', sans-serif; margin: 0; padding: 0; overflow-x: hidden; user-select: none; -webkit-user-select: none; -webkit-touch-callout: none; }
        img { pointer-events: none; -webkit-user-drag: none; }

        /* Full Screen Overlays */
        .overlay-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255, 255, 255, 0.98); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; text-align: center; }
        .spinner { width: 50px; height: 50px; border: 4px solid #f3f3f3; border-top: 4px solid var(--primary); border-radius: 50%; animation: spin 1s linear infinite; margin-bottom: 20px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .progress-container { width: 100%; max-width: 400px; background: #eee; border-radius: 20px; overflow: hidden; height: 15px; margin: 20px 0; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.2s linear; }
        
        /* Dashboard & Header */
        .gallery-header { padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; flex-wrap: wrap; gap: 15px; }
        .brand-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: #000; margin: 0; font-weight: 700; letter-spacing: 1px; }
        .brand-title span { color: var(--primary); }
        .btn-header { border: 1px solid #eee; color: #555; border-radius: 50px; padding: 8px 20px; font-size: 0.85rem; transition: 0.3s; background: #fff; cursor: pointer; display: inline-flex; align-items: center; margin-left: 8px; font-weight: 600; text-decoration: none !important;}
        .btn-header:hover, .btn-header.active { background: var(--primary); border-color: var(--primary); color: #fff; }

        .section-header { margin: 40px 30px 20px; font-family: 'Playfair Display', serif; font-size: 1.8rem; color: #111; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 25px; padding: 0 30px; margin-bottom: 40px; margin-top:30px; }
        .media-card { background: #fff; border-radius: 12px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; cursor: pointer; transition: transform 0.2s; }
        .media-card:hover { transform: translateY(-5px); border-color: var(--primary); }
        .folder-cover { height: 200px; background-size: cover; background-position: center; position: relative; }
        .card-details { padding: 20px; text-align: left; }
        .card-details h5 { margin: 0 0 5px 0; font-weight: 700; font-size: 1.1rem; }

        /* Gallery Grid */
        .container-fluid { padding: 30px; padding-bottom: 120px; }
        .gallery-grid { column-count: 4; column-gap: 20px; }
        @media (max-width: 1200px) { .gallery-grid { column-count: 3; } }
        @media (max-width: 768px) { .gallery-grid { column-count: 2; column-gap: 10px; } .brand-title { font-size: 1.1rem; } }
        
        .gallery-item { break-inside: avoid; margin-bottom: 20px; position: relative; border-radius: 8px; overflow: hidden; cursor: pointer; background: #f0f0f0; transition: 0.2s; }
        .lazy-image { width: 100%; display: block; opacity: 0; transition: opacity 0.5s; }
        .lazy-image.loaded { opacity: 1; }
        .gallery-item.selected { transform: scale(0.96); box-shadow: 0 0 0 3px var(--primary); }
        .gallery-item.selected::after { content: "\f00c"; font-family: "Font Awesome 5 Free"; font-weight: 900; position: absolute; top: 10px; right: 10px; background: var(--primary); color: #fff; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; }

        /* Lightbox & Zoom Engine */
        .modal-content-lb { background-color: rgba(10,10,10,0.98); border: none; height: 100vh; overflow: hidden; }
        .modal-body-lb { padding: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; position: relative; overflow: hidden; }
        .lb-header { position: absolute; top: 0; left: 0; width: 100%; padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; z-index: 1060; background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent); }
        #lightboxImage { max-height: 80vh; max-width: 95vw; object-fit: contain; transition: transform 0.15s ease-out; cursor: zoom-in; will-change: transform; }
        .lb-control { position: absolute; top: 50%; transform: translateY(-50%); width: 60px; height: 60px; background: rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #fff; cursor: pointer; z-index: 1050; font-size: 1.5rem; transition: 0.3s; }
        .lb-control:hover { background: var(--primary); }
        .lb-prev { left: 20px; } .lb-next { right: 20px; }
        .zoom-overlay { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); z-index: 1060; display: flex; gap: 20px; background: rgba(0,0,0,0.7); padding: 10px 25px; border-radius: 50px; }
        .zoom-overlay i { color: #fff; font-size: 1.5rem; cursor: pointer; padding: 5px; }

        /* Selection & Download Bar */
        #selection-bar { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px); background: #222; color: #fff; padding: 12px 30px; border-radius: 50px; z-index: 1050; display: flex; align-items: center; gap: 20px; transition: 0.4s; }
        #selection-bar.visible { transform: translateX(-50%) translateY(0); }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="main-loader" class="overlay-screen">
        <div class="spinner"></div>
        <h4 id="main-loader-text">Connecting to Studio</h4>
    </div>

    <div id="cache-progress-screen" class="overlay-screen" style="display:none; background: #fff;">
        <i class="fas fa-microchip text-warning mb-3" style="font-size: 3rem;"></i>
        <h3>Optimizing Gallery</h3>
        <p>Using Multi-Core Processing for high-quality display.</p>
        <div class="progress-container"><div class="progress-fill" id="cache-fill"></div></div>
        <h5 id="cache-percent">0% Loaded</h5>
        <small id="cache-stats" class="text-muted">0 / 0 Ready</small>
        <div class="mt-4 d-flex">
            <button id="btnContinueLive" class="btn btn-primary font-weight-bold px-4 py-2 mr-3" style="border-radius:50px; display:none;" onclick="finishCacheOptimizer()">
                <i class="fas fa-play mr-2"></i> Continue with Ready Files
            </button>
            <button class="btn btn-outline-dark font-weight-bold px-4 py-2" style="border-radius:50px;" onclick="cancelCacheAndGoBack()">Back</button>
        </div>
    </div>

    <div class="gallery-header">
        <div class="d-flex align-items-center"><h1 class="brand-title" id="pageTitleDisplay"><span>Supriya</span> Studio</h1></div>
        <div>
            <a href="index.html" class="btn-header"><i class="fas fa-home mr-1"></i> Home</a>
            <button class="btn-header" id="btnBackToFolders" onclick="goBackToFolders()" style="display:none;"><i class="fas fa-arrow-left mr-1"></i> Folders</button>
            <button class="btn-header" id="btnSelectMode" style="display:none;" onclick="toggleSelectMode()"><i class="far fa-check-circle mr-1"></i> Select</button>
            <button class="btn-header download-ui d-none" onclick="promptDownloadAll()"><i class="fas fa-download mr-1"></i> All</button>
        </div>
    </div>

    <div id="event-content"></div>
    <div class="container-fluid"><div id="gallery" class="gallery-grid" style="display:none;"></div></div>

    <div id="selection-bar">
        <span class="selection-count">0 Selected</span>
        <button class="btn btn-warning btn-sm font-weight-bold px-3" onclick="promptDownloadSelected()">Download</button>
        <i class="fas fa-times" onclick="clearSelection()" style="cursor:pointer;"></i>
    </div>

    <div class="modal fade" id="lightboxModal" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog modal-xl" style="max-width:100%; margin:0;">
            <div class="modal-content modal-content-lb">
                <div class="modal-body modal-body-lb">
                    <div class="lb-header">
                        <div class="lb-title text-white" id="lbFileName">image.jpg</div>
                        <span class="text-white" style="cursor:pointer; font-size:2rem;" data-dismiss="modal" onclick="resetZoom()">&times;</span>
                    </div>
                    <div class="lb-control lb-prev" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></div>
                    <img id="lightboxImage" src="">
                    <div class="lb-control lb-next" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></div>
                    <div class="zoom-overlay d-none" id="zoom-overlay-ui">
                        <i class="fas fa-search-minus" onclick="adjustZoom(-0.5)"></i>
                        <i class="fas fa-search-plus" onclick="adjustZoom(0.5)"></i>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = "https://supriyadigitals.store/api/";
        const params = new URLSearchParams(window.location.search);
        let fullEventData = []; let galleryData = []; let selectedFiles = new Set();
        let isSelectMode = false; let currentIndex = 0; let canDownload = 0;
        let cacheMissingUrls = []; let cacheTotal = 0; let cacheCompleted = 0;

        async function initializeGallery() {
            try {
                let event = params.get('event') || '';
                let url = `${API_BASE}fetch.php?mode=client&event=${encodeURIComponent(event)}`;
                const response = await fetch(url, { headers: { "ngrok-skip-browser-warning": "69420" } });
                const result = await response.json();
                if (!result.success || result.data.length === 0) return;
                fullEventData = result.data;
                $('#main-loader').fadeOut(300);
                renderFolderDashboard();
            } catch (e) { console.error(e); }
        }

        function renderFolderDashboard() {
            $('#gallery').hide().empty(); $('#event-content').show(); $('.btn-header').not('[href="index.html"]').hide();
            let groups = {};
            fullEventData.forEach(item => {
                if (item.batch_id && (item.type === 'work' || item.type === 'link')) {
                    let path = item.file_path.split('/');
                    let name = path.length > 1 ? path[path.length - 2] : item.title;
                    if (!groups[item.batch_id]) groups[item.batch_id] = { title: name, cover: item.file_path, count: 0 };
                    groups[item.batch_id].count++;
                }
            });
            let html = '<div class="section-header">Collections</div><div class="media-grid">';
            Object.keys(groups).forEach(id => {
                const g = groups[id]; const cover = `${API_BASE}serve_image.php?file=${encodeURIComponent(g.cover)}&thumb=1`;
                html += `<div class="media-card" onclick="openFolder('${id}', '${g.title}')"><div class="folder-cover" style="background-image:url('${cover}')"></div><div class="card-details"><h5>${g.title}</h5><small>${g.count} Photos</small></div></div>`;
            });
            $('#event-content').html(html + '</div>');
        }

        function openFolder(batchId, title) {
            galleryData = fullEventData.filter(i => i.batch_id === batchId);
            canDownload = Math.max(...galleryData.map(i => parseInt(i.can_download) || 0));
            $('#pageTitleDisplay').html(`<i class="fas fa-folder-open text-warning mr-2"></i> ${title}`);
            $('#event-content').hide(); $('#main-loader').show();
            
            $.get(`${API_BASE}cache_manager.php?action=status&batch_id=${batchId}`, function(res) {
                let data = JSON.parse(res);
                cacheTotal = data.total; cacheCompleted = data.cached; cacheMissingUrls = data.missing;
                updateCacheUI();
                $('#main-loader').hide();
                if (cacheMissingUrls.length === 0) finishCacheOptimizer();
                else { $('#cache-progress-screen').fadeIn(); runWorkers(); }
            });
        }

        function updateCacheUI() {
            let pct = Math.round((cacheCompleted / cacheTotal) * 100) || 0;
            $('#cache-fill').css('width', pct + '%');
            $('#cache-percent').text(pct + '% Loaded');
            $('#cache-stats').text(`${cacheCompleted} / ${cacheTotal} Ready`);
            if (cacheCompleted >= 5 || pct >= 10) $('#btnContinueLive').fadeIn();
        }

        function runWorkers() { for(let i=0; i<4; i++) processNext(); }
        function processNext() {
            if (cacheMissingUrls.length === 0) return;
            const url = cacheMissingUrls.shift();
            fetch(`${API_BASE}serve_image.php?file=${encodeURIComponent(url)}&thumb=1`).then(() => {
                cacheCompleted++; updateCacheUI();
                if (cacheCompleted >= cacheTotal) finishCacheOptimizer();
                else processNext();
            });
        }

        function finishCacheOptimizer() {
            $('#cache-progress-screen').fadeOut();
            $('#btnBackToFolders, #btnSelectMode, #gallery').show();
            if(canDownload > 0) $('.download-ui').removeClass('d-none').show();
            renderGallery();
        }

        function renderGallery() {
            let html = '';
            galleryData.forEach((item, index) => {
                const thumb = `${API_BASE}serve_image.php?file=${encodeURIComponent(item.file_path)}&thumb=1`;
                html += `<div class="gallery-item" id="item-${index}" onclick="handleItemClick(${index})"><img data-src="${thumb}" class="lazy-image"></div>`;
            });
            $('#gallery').html(html);
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(en => { if(en.isIntersecting) { en.target.src = en.target.dataset.src; en.target.classList.add('loaded'); observer.unobserve(en.target); } });
            }, { rootMargin: "0px 0px 1000px 0px" });
            document.querySelectorAll('.lazy-image').forEach(img => observer.observe(img));
        }

        function handleItemClick(index) { if (isSelectMode) toggleSelection(index); else openLightbox(index); }
        function toggleSelection(index) {
            const path = galleryData[index].file_path; const $el = $(`#item-${index}`);
            if (selectedFiles.has(path)) { selectedFiles.delete(path); $el.removeClass('selected'); }
            else { selectedFiles.add(path); $el.addClass('selected'); }
            $('.selection-count').text(selectedFiles.size + " Selected");
            if (selectedFiles.size > 0) $('#selection-bar').addClass('visible'); else $('#selection-bar').removeClass('visible');
        }

        function toggleSelectMode() { isSelectMode = !isSelectMode; $('#btnSelectMode').toggleClass('active'); if(!isSelectMode) clearSelection(); }
        function clearSelection() { selectedFiles.clear(); $('.gallery-item').removeClass('selected'); $('#selection-bar').removeClass('visible'); }

        // Zoom Logic
        let currentZoom = 1; const imgEl = document.getElementById('lightboxImage');
        function resetZoom() { currentZoom = 1; imgEl.style.transform = `scale(1)`; }
        function adjustZoom(delta) { currentZoom = Math.min(Math.max(1, currentZoom + delta), 5); imgEl.style.transform = `scale(${currentZoom})`; }

        function openLightbox(index) {
            currentIndex = index; resetZoom();
            const item = galleryData[currentIndex];
            $('#lbFileName').text(item.file_path.split('/').pop());
            imgEl.src = `${API_BASE}serve_image.php?file=${encodeURIComponent(item.file_path)}`;
            $('#lightboxModal').modal('show');
            $('#zoom-overlay-ui').removeClass('d-none');
        }

        function changeImage(dir) {
            currentIndex = (currentIndex + dir + galleryData.length) % galleryData.length;
            openLightbox(currentIndex);
        }

        function goBackToFolders() { clearSelection(); $('#gallery').hide(); renderFolderDashboard(); }
        function cancelCacheAndGoBack() { $('#cache-progress-screen').hide(); goBackToFolders(); }

        initializeGallery();
    </script>
</body>
</html>