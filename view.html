<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Supriya Digitals | Client Gallery</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="img/icon1.png" rel="icon">
    
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.0/css/all.min.css" rel="stylesheet">

    <style>
        :root { --primary: #D4AF37; --text: #333; --bg: #fdfdfd; }
        
        /* CORE SETTINGS */
        body { 
            background-color: var(--bg); color: var(--text); 
            font-family: 'Montserrat', sans-serif; 
            margin: 0; padding: 0; overflow-x: hidden;
            user-select: none; -webkit-user-select: none; /* Privacy */
        }
        img { pointer-events: none; } 

        /* LOADER */
        #main-loader {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #fff; z-index: 9999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .spinner {
            width: 50px; height: 50px; border: 4px solid #f3f3f3;
            border-top: 4px solid var(--primary); border-radius: 50%;
            animation: spin 1s linear infinite; margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* HEADER */
        .gallery-header { 
            padding: 15px 30px; display: flex; justify-content: space-between; align-items: center; 
            background: #fff; box-shadow: 0 4px 20px rgba(0,0,0,0.05); 
            position: sticky; top: 0; z-index: 100; 
        }
        .brand-title { font-family: 'Playfair Display', serif; font-size: 1.4rem; color: #000; margin: 0; font-weight: 700; letter-spacing: 1px; }
        .brand-title span { color: var(--primary); }
        
        .btn-header { 
            border: 1px solid #eee; color: #555; border-radius: 50px; 
            padding: 8px 20px; font-size: 0.85rem; transition: 0.3s; 
            background: #fff; cursor: pointer; display: inline-flex; align-items: center; 
            margin-left: 10px; font-weight: 600;
        }
        .btn-header:hover, .btn-header.active { background: var(--primary); border-color: var(--primary); color: #fff; }

        /* EVENT SECTIONS (NEW) */
        .section-header {
            margin: 40px 30px 20px; font-family: 'Playfair Display', serif;
            font-size: 1.8rem; color: #111; border-bottom: 2px solid #eee; padding-bottom: 10px;
        }

        .media-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 0 30px; margin-bottom: 40px; }
        
        .media-card { background: #fff; border-radius: 8px; overflow: hidden; box-shadow: 0 5px 15px rgba(0,0,0,0.05); border: 1px solid #eee; }
        .video-wrapper { position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden; }
        .video-wrapper iframe { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .card-details { padding: 15px; text-align: center; font-weight: 600; font-size: 0.9rem; }

        /* GALLERY GRID (ORIGINAL MASONRY) */
        .container-fluid { padding: 30px; padding-bottom: 120px; }
        .gallery-grid { column-count: 4; column-gap: 20px; }
        
        @media (max-width: 1200px) { .gallery-grid { column-count: 3; } }
        @media (max-width: 768px) { .gallery-grid { column-count: 2; column-gap: 10px; } .container-fluid { padding: 15px; } .brand-title { font-size: 1.1rem; } .section-header { margin: 20px 15px 15px; } .media-grid { padding: 0 15px; } }
        @media (max-width: 480px) { .gallery-grid { column-count: 1; } }
        
        .gallery-item { 
            break-inside: avoid; margin-bottom: 20px; position: relative; 
            border-radius: 8px; overflow: hidden; cursor: pointer; 
            background: #f0f0f0; transition: transform 0.2s; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        /* SMART LAZY LOAD CSS */
        .lazy-image { width: 100%; display: block; opacity: 0; filter: blur(5px); transition: opacity 0.5s ease-in, filter 0.5s ease-in; }
        .lazy-image.loaded { opacity: 1; filter: blur(0); }

        /* SELECTION MODE */
        .gallery-item.selected { transform: scale(0.96); box-shadow: 0 0 0 3px var(--primary); }
        .gallery-item.selected::after {
            content: "\f00c"; font-family: "Font Awesome 5 Free"; font-weight: 900;
            position: absolute; top: 10px; right: 10px;
            background: var(--primary); color: #fff;
            width: 28px; height: 28px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
        }

        /* FLOATING ACTION BAR */
        #selection-bar {
            position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%) translateY(150px);
            background: #222; color: #fff; padding: 12px 30px; border-radius: 50px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.4); z-index: 1050;
            display: flex; align-items: center; gap: 20px; transition: 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        #selection-bar.visible { transform: translateX(-50%) translateY(0); }
        .btn-download-batch { background: var(--primary); color: #fff; border: none; padding: 8px 25px; border-radius: 20px; font-weight: 700; cursor: pointer; }

        /* QUEUE OVERLAY (NEW) */
        #queue-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.9); z-index: 9999; display: none;
            flex-direction: column; align-items: center; justify-content: center; padding: 20px;
        }
        .queue-box { background: #fff; padding: 30px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); text-align: center; max-width: 400px; width: 100%; border: 1px solid #eee; }

        /* LIGHTBOX */
        .modal-content { background-color: rgba(10,10,10,0.98); border: none; height: 100vh; }
        .modal-body { padding: 0; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        
        .lb-header { 
            position: absolute; top: 0; left: 0; width: 100%; padding: 20px 30px; 
            display: flex; justify-content: space-between; align-items: center; z-index: 1060; 
            background: linear-gradient(to bottom, rgba(0,0,0,0.8) 0%, transparent 100%); 
            pointer-events: none; 
        }
        .lb-header > * { pointer-events: auto; } 
        .lb-title { color: #fff; font-size: 1.1rem; opacity: 0.8; }
        .lb-actions { display: flex; align-items: center; }
        
        .lb-icon { font-size: 1.4rem; color: #fff; cursor: pointer; margin-left: 25px; opacity: 0.7; transition: 0.3s; }
        .lb-icon:hover { opacity: 1; color: var(--primary); }
        
        #lightboxImage { 
            max-height: 80vh; max-width: 95vw; margin-top: 60px; object-fit: contain; box-shadow: 0 0 50px rgba(0,0,0,0.5); 
        }
        
        /* NAVIGATION ARROWS */
        .lb-control { 
            position: absolute; top: 50%; transform: translateY(-50%); 
            width: 50px; height: 50px; background: rgba(255,255,255,0.1); 
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            color: #fff; cursor: pointer; transition: 0.3s; 
        }
        .lb-control:hover { background: var(--primary); }
        .lb-prev { left: 20px; } .lb-next { right: 20px; }

        /* DROPDOWN MENU */
        .dropdown-menu-dark { background: #222; border: 1px solid #444; }
        .dropdown-item { color: #eee; padding: 10px 20px; border-bottom: 1px solid #333; }
        .dropdown-item:last-child { border: 0; }
        .dropdown-item:hover { background: var(--primary); color: #fff; }
    </style>
</head>
<body oncontextmenu="return false;">

    <div id="main-loader">
        <div class="spinner"></div>
        <p class="text-muted small font-weight-bold" id="loader-text">CONNECTING TO STUDIO</p>
    </div>

    <div id="queue-overlay">
        <div class="queue-box">
            <div class="spinner" style="margin: 0 auto 20px;"></div>
            <h4 style="margin-top: 0; color: #111;">Preparing Download</h4>
            <p style="color: #666; font-size: 0.9rem;">Your Synology NAS is gathering the files. This process runs safely in the background.</p>
            <button class="btn btn-danger w-100 mt-3 font-weight-bold" style="border-radius: 20px;" onclick="cancelQueue()">Cancel Request</button>
        </div>
    </div>

    <div class="gallery-header">
        <div class="d-flex align-items-center">
            <h1 class="brand-title" id="pageTitleDisplay"><span>Supriya</span> Studio</h1>
        </div>
        
        <div>
            <button class="btn-header" id="btnSelectMode" onclick="toggleSelectMode()">
                <i class="far fa-check-circle mr-2"></i> Select
            </button>
            
            <button class="btn-header download-ui d-none" onclick="downloadAllImages()">
                <i class="fas fa-download mr-2"></i> All
            </button>
        </div>
    </div>

    <div id="event-content"></div>

    <div class="container-fluid">
        <div id="gallery" class="gallery-grid"></div>
    </div>

    <div id="selection-bar">
        <span class="selection-count text-white font-weight-bold">0 Selected</span>
        <button class="btn-download-batch download-ui d-none" onclick="downloadSelectedBatch()">
            <i class="fas fa-cloud-download-alt mr-2"></i> Download
        </button>
        <button class="btn btn-sm btn-outline-light rounded-circle border-0" onclick="clearSelection()" title="Clear">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <div class="modal fade" id="lightboxModal" tabindex="-1" data-backdrop="static">
        <div class="modal-dialog modal-xl" style="max-width: 100%; margin: 0;">
            <div class="modal-content">
                <div class="modal-body">
                    
                    <div class="lb-header">
                        <div class="lb-title" id="lbFileName">image.jpg</div>
                        <div class="lb-actions">
                            <div class="dropdown download-ui d-none">
                                <span class="lb-icon" data-toggle="dropdown">
                                    <i class="fas fa-download"></i>
                                </span>
                                <div class="dropdown-menu dropdown-menu-right dropdown-menu-dark">
                                    <a class="dropdown-item" href="#" onclick="downloadSingleImage('normal')">
                                        <i class="fas fa-bolt mr-2 text-warning"></i> Fast Download (Web Size)
                                    </a>
                                    <a class="dropdown-item" href="#" onclick="downloadSingleImage('full')">
                                        <i class="fas fa-star mr-2 text-primary"></i> Full Quality (Original)
                                    </a>
                                </div>
                            </div>
                            
                            <span class="lb-icon" data-dismiss="modal"><i class="fas fa-times"></i></span>
                        </div>
                    </div>

                    <div class="lb-control lb-prev" onclick="changeImage(-1)"><i class="fas fa-chevron-left"></i></div>
                    <img id="lightboxImage" src="" alt="Gallery">
                    <div class="lb-control lb-next" onclick="changeImage(1)"><i class="fas fa-chevron-right"></i></div>

                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>

    <script>
        const API_BASE = "https://supriyadigitals.store/api/";
        const params = new URLSearchParams(window.location.search);
        
        let galleryData = []; 
        let selectedFiles = new Set();
        let isSelectMode = false;
        let currentIndex = 0;
        let canDownload = false;

        function escapeHtml(unsafe) {
            return (unsafe || "").toString().replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        async function initializeGallery() {
            try {
                let url = `${API_BASE}fetch.php?mode=shared`;
                const eventName = params.get('event');
                const batchId = params.get('batch_id');

                if (eventName) {
                    $('#pageTitleDisplay').html(`<span>Event:</span> ${escapeHtml(eventName)}`);
                    url = `${API_BASE}fetch.php?mode=client&type=all`; // Fetch all to filter by event
                } else if (batchId) {
                    url += `&batch_id=${batchId}`;
                }

                // 15-second timeout to handle Synology connection issues safely
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 15000);

                const response = await fetch(url, { signal: controller.signal, headers: { "ngrok-skip-browser-warning": "69420" } });
                clearTimeout(timeoutId);
                const result = await response.json();

                if (!result.success || result.data.length === 0) {
                    $('#main-loader').html('<h4 class="text-danger">Gallery Not Found</h4>');
                    return;
                }

                let finalData = result.data;

                // If loading a Master Event Link, filter the data
                if (eventName) {
                    finalData = result.data.filter(item => item.title === eventName);
                    if(finalData.length === 0) {
                        $('#main-loader').html('<h4 class="text-danger">Event Not Found</h4>');
                        return;
                    }
                    // Sort using Admin's drag-and-drop order
                    finalData.sort((a, b) => (a.order_index || 0) - (b.order_index || 0));
                    renderEventSections(finalData); // Renders Videos and Albums at the top
                }

                // Filter down to just photos for the Masonry Grid
                galleryData = finalData.filter(i => i.type === 'work' || !i.type); // Fallback for old data
                
                canDownload = galleryData.some(item => item.can_download == 1);
                if (canDownload) {
                    $('.download-ui').removeClass('d-none');
                }

                renderGallery();
                $('#main-loader').fadeOut(500);

            } catch (e) {
                console.error(e);
                $('#main-loader').html(`
                    <i class="fas fa-server text-danger" style="font-size: 3rem; margin-bottom:15px;"></i>
                    <h5 class="text-danger">Server Not Available</h5>
                    <p class="text-muted small">Please try refreshing in a few minutes.</p>
                `);
            }
        }

        // --- RENDER VIDEOS AND ALBUMS (MASTER EVENT) ---
        function renderEventSections(data) {
            const videos = data.filter(i => i.type === 'teaser');
            const albums = data.filter(i => i.type === 'album');
            let html = '';

            if (videos.length > 0) {
                html += `<div class="section-header">Event Films</div><div class="media-grid">`;
                videos.forEach(v => {
                    let ytId = v.file_path ? (v.file_path.split('v=')[1] || v.file_path.split('youtu.be/')[1] || "").split('&')[0] : "";
                    const catText = v.video_category ? escapeHtml(v.video_category) : 'Video';
                    html += `
                    <div class="media-card">
                        <div class="video-wrapper"><iframe src="https://www.youtube.com/embed/${ytId}" frameborder="0" allowfullscreen></iframe></div>
                        <div class="card-details">${catText}</div>
                    </div>`;
                });
                html += `</div>`;
            }

            if (albums.length > 0) {
                html += `<div class="section-header">Digital Albums</div><div class="media-grid">`;
                albums.forEach(a => {
                    html += `
                    <div class="media-card" style="padding: 30px 15px; text-align: center;">
                        <i class="fas fa-book-reader" style="font-size: 3rem; color: var(--primary); margin-bottom: 15px;"></i>
                        <div class="card-details" style="padding-bottom: 5px;">Karizma Album</div>
                        <a href="${escapeHtml(a.file_path)}" target="_blank" class="btn-header" style="background:var(--primary); color:#fff; text-decoration:none;">View Album</a>
                    </div>`;
                });
                html += `</div>`;
            }

            if(galleryData.length > 0) {
                html += `<div class="section-header">Photo Gallery</div>`;
            }

            $('#event-content').html(html);
        }

        // --- RENDER MASONRY PHOTO GRID ---
        function renderGallery() {
            let html = '';
            galleryData.forEach((item, index) => {
                const imgUrl = item.file_path; 
                const fname = item.clean_name || item.file_path.split('/').pop();
                
                galleryData[index].fullUrl = imgUrl; 
                galleryData[index].filename = fname;

                // SMART LAZY LOAD IMPLEMENTATION
                // Uses serve_image.php to compress huge Synology files on-the-fly to tiny web JPEGs
                const smartUrl = `${API_BASE}serve_image.php?file=${encodeURIComponent(imgUrl)}`;

                html += `
                    <div class="gallery-item" id="item-${index}" onclick="handleItemClick(${index})">
                        <img data-src="${smartUrl}" class="lazy-image" alt="Photo" decoding="async">
                    </div>`;
            });
            document.getElementById('gallery').innerHTML = html;

            // Trigger the Lazy Loader
            initLazyLoader();
        }

        // --- LAZY LOADER ENGINE ---
        function initLazyLoader() {
            const imageObserver = new IntersectionObserver((entries, observer) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const img = entry.target;
                        img.src = img.getAttribute('data-src');
                        img.onload = () => img.classList.add('loaded');
                        observer.unobserve(img); // Stop watching once loaded
                    }
                });
            }, { rootMargin: "0px 0px 500px 0px" }); // Load when 500px away from viewport

            document.querySelectorAll('.lazy-image').forEach(img => imageObserver.observe(img));
        }

        // --- INTERACTION ---
        function toggleSelectMode() {
            isSelectMode = !isSelectMode;
            $('#btnSelectMode').toggleClass('active');
            if(!isSelectMode) clearSelection();
        }

        function handleItemClick(index) {
            if (isSelectMode) toggleSelection(index);
            else openLightbox(index);
        }

        function toggleSelection(index) {
            const item = galleryData[index];
            const $el = $(`#item-${index}`);
            
            if (selectedFiles.has(item.fullUrl)) {
                selectedFiles.delete(item.fullUrl);
                $el.removeClass('selected');
            } else {
                selectedFiles.add(item.fullUrl);
                $el.addClass('selected');
            }
            updateFloatingBar();
        }

        function clearSelection() {
            selectedFiles.clear();
            $('.gallery-item').removeClass('selected');
            updateFloatingBar();
        }

        function updateFloatingBar() {
            const count = selectedFiles.size;
            $('.selection-count').text(count + " Selected");
            if (count > 0) $('#selection-bar').addClass('visible');
            else $('#selection-bar').removeClass('visible');
        }

        // --- QUEUED DOWNLOAD LOGIC ---
        function downloadAllImages() {
            if(!canDownload) return alert("Download not allowed.");
            if(!confirm(`Download all ${galleryData.length} images? This process will run in the background.`)) return;
            
            $('#queue-overlay').css('display', 'flex');
            
            // Post Full URLs to the batch downloader script
            postDownload(galleryData.map(i => i.fullUrl));
        }

        function downloadSelectedBatch() {
            if (selectedFiles.size === 0) return;
            $('#queue-overlay').css('display', 'flex');
            postDownload(Array.from(selectedFiles));
        }

        function postDownload(filesArray) {
            // Uses your existing download.php to handle the batch ZIP logic
            const form = document.createElement("form");
            form.method = "POST";
            form.action = `${API_BASE}download.php`;
            const input = document.createElement("input");
            input.type = "hidden";
            input.name = "files";
            input.value = JSON.stringify(filesArray);
            form.appendChild(input);
            document.body.appendChild(form);
            form.submit();
            
            // Hide queue UI after submission initiates
            setTimeout(() => {
                document.body.removeChild(form);
                $('#queue-overlay').fadeOut();
                clearSelection();
            }, 3000);
        }

        function cancelQueue() {
            $('#queue-overlay').fadeOut();
        }

        // --- DUAL DOWNLOAD FOR SINGLE IMAGES ---
        function downloadSingleImage(type) {
            const item = galleryData[currentIndex];
            if(item.can_download != 1) return;

            if (type === 'normal') {
                // Fast Download: Triggers serve_image.php with dl=1
                window.location.href = `${API_BASE}serve_image.php?dl=1&file=${encodeURIComponent(item.fullUrl)}`;
            } else {
                // Original Quality: Triggers download_full.php (Handles background kills if aborted)
                window.location.href = `${API_BASE}download_full.php?file=${encodeURIComponent(item.fullUrl)}`;
            }
        }

        // --- LIGHTBOX ---
        function openLightbox(index) {
            currentIndex = index;
            updateLightbox();
            $('#lightboxModal').modal('show');
        }

        function updateLightbox() {
            const item = galleryData[currentIndex];
            
            // Lightbox uses the smart compressed image to load instantly, saving GBs of data transfer
            const smartUrl = `${API_BASE}serve_image.php?file=${encodeURIComponent(item.fullUrl)}`;
            $('#lightboxImage').attr('src', smartUrl);
            
            $('#lbFileName').text(item.filename || `Image ${currentIndex + 1}`);
            
            if (item.can_download == 1) $('.download-ui').removeClass('d-none');
            else $('.download-ui').addClass('d-none');
        }

        function changeImage(dir) {
            currentIndex += dir;
            if (currentIndex >= galleryData.length) currentIndex = 0;
            if (currentIndex < 0) currentIndex = galleryData.length - 1;
            updateLightbox();
        }

        document.addEventListener('keydown', (e) => {
            if ($('#lightboxModal').is(':visible')) {
                if (e.key === "ArrowLeft") changeImage(-1);
                if (e.key === "ArrowRight") changeImage(1);
            }
        });

        initializeGallery();
    </script>
</body>
</html>